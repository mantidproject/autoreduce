{% extends "base.html" %}
{% load colour_table_rows %}
{% load get_user_name %}
{% load naturaltime from humanize %}
{% load static from staticfiles %}

{% block body %}
    <title>Failed Jobs</title>
    {% if queue %}
        <div class="column">
            <div class="row">
                <div class="col-md-12 text-center">
                    <h2>Failed Jobs</h2>
                </div>
            </div>
            <div>
                <select id="runAction">
                    <option value="default">Select action to apply to selected runs</option>
                    <option value="rerun">Re-run </option>
                    <option value="hide">Hide </option>
                    <option value="cancel">Stop retrying</option>
                </select>
                <button type="button" id="runActionButton">Apply</button>
            </div>
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th><input type='checkbox' id="selectAllRuns"></th>
                        <th>Run Number</th>
                        <th>Instrument</th>
                        <th>Message</th>
                        <th>Submitted</th>
                        <th>Retrying</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in queue %}
                      {% if job.retry_run %}
                        <tr name='runRow' class="{% colour_table_row job.retry_run.status.value %}">
                      {% else %}
                        <tr name='runRow' class="{% colour_table_row job.status.value %}">
                      {% endif %}
                            <td><input type='checkbox' name='runCheckbox' data-run_number='{{job.run_number}}' data-run_version='{{job.run_version}}' data-rb_number='{{job.experiment.reference_number}}'></td>
                            <td>
                                <a href="{% url 'run_summary' run_number=job.run_number run_version=job.run_version %}">{{ job.title }}</a>
                            </td>
                            <td>{{ job.instrument.name }}</td>
                            <td style="width:600px;"><strong>{{ job.message }}</strong></td>
                            <td title="{{ job.created|date:'SHORT_DATETIME_FORMAT' }}">{{ job.created|naturaltime }}</td>
                            <td>
                                {% if job.retry_when %}
                                    {{ job.retry_when|naturaltime }}
                                    {% if job.cancel %}
                                        <span> (Last attempt)</span>
                                    {% endif %}
                                    {% if job.retry_run %}
                                        <a href="{% url 'run_summary' run_number=job.retry_run.run_number run_version=job.retry_run.run_version %}"> ({{ job.retry_run.status }})</a>
                                    {% endif %}
                                {% else %}
                                    Never
                                {% endif %}
                            </td>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="row">
            <div class="col-md-12 text-center">
                <h3>No failed jobs.</h3>
            </div>
        </div>
    {% endif %} 
{% endblock %}

{% block scripts %}
    <script type="text/javascript"> window.CSRF_TOKEN = "{{ csrf_token }}"; </script>
    <script src='{% static "javascript/fail_queue.js" %}'> </script>
{% endblock %}